# 为页面获取数据

得益于 Dace 路由API的优点，我们知道了如何创建一个具有简洁 URL 的 Dace 应用程序。

实际上，我们通常需要从远程数据源获取数据。Dace 提供了一个标准 API 用于为页面获取数据。我们使用一个 `async` 静态方法 `getInitialProps` 来达到获取数据的目的。

以此为基础，我们能够给以页面从远程数据源获取数据，然后把数据传给我们的一个页面组件的属性。我们可以编写 `getInitialProps` 函数让他能够同时在客户端和服务器端运行。

在这节课中，使用 `getInitialProps`，我们将使用 [TVmaze API](http://www.tvmaze.com/api)构造一个显示 Batman TV Shows 相关信息的应用程序。

现在开始!

## 设置

下载需要的示例程序:

```shell
git clone https://github.com/dacejs/learn-dace-demo.git
cd learn-dace-demo
git checkout 05.clean-urls
```

用下面的命令运行:

```shell
npm install
npm start
```

然后，访问 [http://localhost:3000](http://localhost:3000)

## 获取 Batman Shows

在我们的演示程序中，显示了一个博客列表，现在我们改造演示程序以要显示一个 Batman TV shows 列表。

和之前博客列表的硬编码方式不同，这次我们从远程服务器获取列表数据。

> 这里我们使用 [TVMaze API](http://www.tvmaze.com/api) 获取电视节目信息，它是一个搜索电视节目信息的 API。

首先，我们使用 [axios](https://github.com/axios/axios) 来获取数据。它是一个浏览器 [fetch](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch) 的简单实现，并且可以同时工作在客户端和服务器端环境中。

安装 axios：

```
npm i axios
```

> 译注: 这类能够同时在客户端和服务器运行的应用程序，我们称之为`同构应用程序`

然后，用下面的代码，替换 `src/pages/index.jsx` 文件:

```js
import React, { Component } from 'react';
import PropTypes from 'prop-types';
import { connect } from 'react-redux';
import { prefetch, Link, Head } from 'dace';
import { fetchMovies } from './action';
import reducer from './reducer';
import Layout from '../layouts/default';

const defaultProps = {
  movies: []
};

function mapStateToProps(state) {
  return { movies: state.home.data || [] };
}

@prefetch({
  key: 'home',
  reducer,
  promise: ({ store: { dispatch } }) => dispatch(fetchMovies())
})
@connect(mapStateToProps, { fetchMovies })
export default class Home extends Component {
  static propTypes = {
    movies: PropTypes.arrayOf(PropTypes.shape({
      id: PropTypes.number,
      name: PropTypes.string
    }))
  };

  static defaultProps = defaultProps;

  render() {
    const { movies } = this.props;

    return (
      <Layout>
        <Head>
          <title>{`${movies.length} movies Loaded`}</title>
        </Head>
        <h1>Batman TV Shows</h1>
        <ul>
          {
            movies.map(movie => (
              <li key={movie.id}>
                <Link to={`/post/${movie.id}`}>{movie.name}</Link>
              </li>
            ))
          }
        </ul>
      </Layout>
    );
  }
}
```

因为页面使用的是 redux，所以需要再为页面增加 `action.js` `reducer.js`:

```js
// src/pages/home/action.js
import { isLoaded } from 'dace';

export const FETCH_MOVIES = 'fetch_movies';
export const fetchMovies = () => async (dispatch, getState, api) => {
  const { movies } = getState();
  if (!isLoaded(movies)) {
    const res = await api.get('http://api.tvmaze.com/search/shows?q=batman');
    dispatch({
      type: FETCH_MOVIES,
      payload: res
    });
  } else {
    console.log('state.movies已经获取过');
  }
};
```

```js
// src/pages/home/reducer.js
import { FETCH_MOVIES } from './action';

export default (state = [], action) => {
  switch (action.type) {
    case FETCH_MOVIES:
      return {
        data: action.payload.data.map(({ show: { id, name } }) => ({ id, name }))
      };
    default:
      return state;
  }
};
```

到现在，上面的代码一切看来都是很熟悉了，除了 `@prefetch`:

```js
@prefetch({
  key: 'home',
  reducer,
  promise: ({ store: { dispatch } }) => dispatch(fetchMovies())
})
```

这是一个装饰器，可以把它添加到应用程序中的任何页面。使用它，我们可以获取数据，并且作为页面组件的属性使用.

如你所见，现在，我们要获取 Batman TV 电视节目信息，并且把获取的节目信息，作为页面组件的 `shows` 属性进行访问.

![Fetching data as component property](https://cloud.githubusercontent.com/assets/50838/26300128/de007dd6-3efa-11e7-9084-6ba7ff10774b.png)

如你所见，上面的 `getInitialProps` 函数，它打印一系列获取到的数据到控制台.

现在，看一下浏览器的控制台和服务器的控制台输出。然后重新加载页面.

## 仅服务器

本来我们预想的，客户端和服务器都能输出同样的信息，但实际上，在这种情况下，输出信息只显示在了服务器端的控制台上。这是因为，我们的页面是在服务器端进行渲染的。我们在服务器上已经获取到了电视节目的数据，没有理由在客户端再获取一次.

## 实现信息展示页面

现在我们要实现一个 `/post` 页面来展示电视节目的详细信息。

用下面的代码替换 `pages/post.js` 的内容：

```js
import React, { Component } from 'react';
import PropTypes from 'prop-types';
import { connect } from 'react-redux';
import { prefetch } from 'dace';
import { fetchMovie } from './action';
import reducer from './reducer';
import Layout from '../../layouts/default';

const defaultProps = {
  movie: {}
};

function mapStateToProps(state) {
  return { movie: state.post.data || defaultProps };
}

@prefetch({
  key: 'post',
  reducer,
  promise: ({ store: { dispatch }, match }) => dispatch(fetchMovie(match.params.id))
})
@connect(mapStateToProps, { fetchMovie })
export default class Post extends Component {
  static propTypes = {
    movie: PropTypes.object
  };

  static defaultProps = defaultProps;

  render() {
    const { name, summary, image } = this.props.movie;
    return (
      <Layout>
        <h1>{name}</h1>
        <p>{summary}</p>
        {image && <img alt={`${name}`} src={image.medium} />}
      </Layout>
    );
  }
}
```

```js
// src/pages/post/action.js
export const FETCH_MOVIE = 'fetch_movie';
export const fetchMovie = id => async (dispatch, getState, api) => {
  const res = await api.get(`http://api.tvmaze.com/shows/${id}`);
  dispatch({
    type: FETCH_MOVIE,
    payload: res
  });
};
```


```js
// src/pages/post/reducer.js
import { FETCH_MOVIE } from './action';

export default (state = [], action) => {
  switch (action.type) {
    case FETCH_MOVIE:
      return {
        data: action.payload.data
      };
    default:
      return state;
  }
};
```
我们再来看一下 `@prefetch` 函数:

```js
@prefetch({
  key: 'post',
  reducer,
  promise: ({ store: { dispatch }, match }) => dispatch(fetchMovie(match.params.id))
})
```

现在这个函数的第一个参数为一个 `context` 对象，其中包含了我们用于获取信息的查询字段.

在我们这个例子中，我们从查询串中获取电视节目ID，然后通过它来从 TVMaze API 获取数据.

在 `getInitialProps`函数中，我们添加了一个 `console.log` 调试输出来显示电视节目的标题。下面我们来验证我们的程序是否能够正确运行.

打开服务器和客户端控制台，访问 [http://localhost:3000](http://localhost:3000)，点击第一个电视节目标题.

输出显示在客户端还是服务器控制台?

## 从客户端获取数据

这里，我们只在客户端的控制台上看到了调试输入。这是因为我们是通过客户端进行导航的。因此从客户端获取数据是更好的方式.

如果你直接访问Post页面(例如: http://localhost:3000/p/975)，你将会看到调试输出显示在了服务器端而非客户端.

## 最后

现在你学到了 Dace 最为关键的特性: `通用数据获取`和`服务器端渲染(SRR)`.

我们了解了 `getInitialProps`，在大多数情况下，就足够了。如果你要了解关于数据获取的更加深入的信息，参考[data fetching](https://github.com/zeit/next.js#fetching-data-and-component-lifecycle) 文档.
